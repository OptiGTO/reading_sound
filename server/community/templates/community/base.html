<!--File: community/templates/community/base.html-->

{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>읽는소리 - {% block title %}{% endblock %}</title>
  
  <!-- Updated path to CSS -->
  <link rel="stylesheet" href="{% static 'community/css/style.css' %}" />

  <!-- Font Awesome (Optional) -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
<!-- 캐시 방지 (서버 가부하 시 삭제)-->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

</head>

<body>
  <!-- 왼쪽 사이드바 -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <!-- Updated logo path -->
      <img src="{% static 'community/images/logo.png' %}" alt="읽는소리" class="brand-logo" />
    </div>
    
    <!-- 로그인 / 회원가입 버튼 -->
    <div class="login-container">
      {% if user.is_authenticated %}
    <span>당신의 글이 울리는 곳, {{ user.username }}</span>
    <form action="{% url 'logout' %}" method="post" style="display: inline;">
      {% csrf_token %}
      <button type="submit" class="btn hover-effect">로그아웃</button>
    </form>
  {% else %}
    <a href="{% url 'community:login' %}" class="btn hover-effect">로그인</a>
    <a href="{% url 'community:signup' %}" class="btn hover-effect">회원가입</a>
  {% endif %}
</div>

   <!-- 내비게이션 메뉴 -->
    
<nav class="nav-menu">
  <ul>
    <!-- 1) 홈 -->
    <li>
      <a href="{% url 'community:home' %}" class="nav-link{% if request.resolver_match.url_name == 'home' %} active{% endif %}">
        <i class="fas fa-home"></i>
        <span>홈</span>
      </a>
    </li>

    <!-- 서평 -->
    <li>
      <a href="{% url 'community:book_sound' %}" class="nav-link{% if request.resolver_match.url_name == 'book_sound' %} active{% endif %}">
        <i class="fas fa-book"></i>
        <span>책 게시글 </span>
      </a>
    </li>

    <li>
      <a href="{% url 'community:reading_meeting' %}" class="nav-link{% if request.resolver_match.url_name == 'reading_meeting' %} active{% endif %}">
        <i class="fas fa-book"></i>
        <span>독서 모임 </span>
      </a>
    </li>

    <!-- 독서 콘텐츠 -->
    <li class="has-submenu">
      <a href="{% url 'community:reading_meeting' %}" class="nav-link{% if 'group-section' in request.path %} active{% endif %}">
        <i class="fas fa-users"></i>
        <span>책 이벤트</span>
      </a>
      <ul class="submenu">
        <li>
          <a href="{% url 'community:reading_meeting' %}" class="{% if request.resolver_match.url_name == 'reading_meeting' %}active{% endif %}">
            <i class="fas fa-users"></i>
            <span>독서 모임</span>
          </a>
        </li>
        <li>
          <a href="{% url 'community:review_event' %}" class="{% if request.resolver_match.url_name == 'review_event' %}active{% endif %}">
            <i class="fas fa-pencil-alt"></i>
            <span>서평 이벤트</span>
          </a>
        </li>
        <li>
          <a href="{% url 'community:booktalk' %}" class="{% if request.resolver_match.url_name == 'booktalk' %}active{% endif %}">
            <i class="fas fa-comments"></i>
            <span>북토크</span>
          </a>
        </li>
        <li>
          <a href="{% url 'community:your_content' %}" class="{% if request.resolver_match.url_name == 'your_content' %}active{% endif %}">
            <i class="fas fa-pencil-alt"></i>
            <span>개인 이벤트</span>
          </a>
        </li>
       
      </ul>
    </li>

    <!-- 4) 추천 도서 -->
    <li>
      <a href="{% url 'community:recommend_book' %}" class="nav-link{% if request.resolver_match.url_name == 'recommend_book' %} active{% endif %}">
        <i class="fas fa-star"></i>
        <span>BOOK소리 - 추천 도서</span>
      </a>
    </li>

    <!-- 5) 공지사항 -->
    <li>
      <a href="{% url 'community:notice' %}" class="nav-link{% if request.resolver_match.url_name == 'notice' %} active{% endif %}">
        <i class="fas fa-bell"></i>
        <span>공지사항</span>
      </a>
    </li>
  </ul>
</nav>
    
    <!-- 무작위 책 추천 섹션 -->
    <div class="random-book-section">
      <h2>무작위 책</h2>
      <div id="random-book-container"></div>
      <button class="btn hover-effect" id="random-book-btn">놀라게 해줘!</button>
    </div>
  </aside>
  

  <!-- 메인 콘텐츠 영역 -->
  <main class="content">
    <!-- 상단 바 -->
    <header class="top-bar">
      <div class="user-info" id="user-info">
        <span id="user-nickname"> {{ user.username }} </span>
      </div>
    </header>


    <div class="messages-container">
      {% if messages %}
          {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
          {% endfor %}
      {% endif %}
  </div>
 <!---------------------------------------------------------------------------------------------------------->
   
 
 
    {% block content %}
    {% endblock %}
  </main>

<!---------------------------------------------------------------------------------------------------------->


  <!-- 오른쪽 사이드바 -->
  <aside class="sidebar right-sidebar">

    <!-- 검색창 -->
    <div class="search-container">
      <input type="text" id="search-input" placeholder="게시글 검색..." />
      <button class="btn hover-effect" id="search-btn">검색</button>
    </div>

    <!-- 이벤트, 독서모임, 독서팁 섹션 -->
    <div class="sidebar-section">
        <h2>이벤트</h2>
        <div class="event-list">
            {% for event in sidebar.events %}
            <div class="event-item">
                <h4>{{ event.title }}</h4>
                <p class="event-date">{{ event.event_date|date:"Y.m.d" }}</p>
                <p class="event-content">{{ event.content|truncatechars:50 }}</p>
                {% if user.is_staff %}
                <a href="{% url 'admin:community_eventpost_change' event.id %}" class="edit-link">Edit</a>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="sidebar-section">
        <h2>독서모임</h2>
        <div class="group-list">
            {% for group in sidebar.reading_groups %}
            <div class="group-item">
                <h4>{{ group.title }}</h4>
                <p class="meeting-time">{{ group.meeting_time|date:"Y.m.d H:i" }}</p>
                <p class="group-content">{{ group.content|truncatechars:50 }}</p>
                {% if user.is_staff %}
                <a href="{% url 'admin:community_readinggrouppost_change' group.id %}" class="edit-link">Edit</a>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="sidebar-section">
        <h2>독서팁</h2>
        <div class="tip-list">
            {% for tip in sidebar.tips %}
            <div class="tip-item">
                <h4>{{ tip.title }}</h4>
                <p class="tip-category">{{ tip.category }}</p>
                <p class="tip-content">{{ tip.content|truncatechars:50 }}</p>
                {% if user.is_staff %}
                <a href="{% url 'admin:community_readingtippost_change' tip.id %}" class="edit-link">Edit</a>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
  </aside>

  <!-- 플로팅 글쓰기 버튼 -->
  {% if user.is_authenticated %}  
  <div class="floating-btn-container">
    <a href="{% url 'community:post' %}" class="btn fab hover-effect" id="post-btn">+</a>
  </div>
  {% endif %}

  <script>
    // 1. 무작위 책 추천 기능                                                           // 랜덤 책 추천 기능
    const adminGeneratedBooks = [
      { title: "1984", author: "George Orwell", genre: "Dystopian" },
      { title: "To Kill A Mockingbird", author: "Harper Lee", genre: "Classic" },
      { title: "The Great Gatsby", author: "F. Scott Fitzgerald", genre: "Classic" },
      { title: "Pride and Prejudice", author: "Jane Austen", genre: "Romance" },
      { title: "Fahrenheit 451", author: "Ray Bradbury", genre: "Sci-Fi" },
    ];

    const randomBookBtn = document.getElementById("random-book-btn");
    const randomBookContainer = document.getElementById("random-book-container");

    function getRandomBook() {
      const randomIndex = Math.floor(Math.random() * adminGeneratedBooks.length);
      const book = adminGeneratedBooks[randomIndex];
      randomBookContainer.innerHTML = `
        <p><strong>Title:</strong> ${book.title}</p>
        <p><strong>Author:</strong> ${book.author}</p>
        <p><strong>Genre:</strong> ${book.genre}</p>
      `;
    }

    if (randomBookBtn) {
      randomBookBtn.addEventListener("click", getRandomBook);
    }

    // 2. 서브섹션 네비게이션                                                          // 서브섹션 네비게이션 처리
    document.querySelectorAll('.sub-link').forEach(button => {
      button.addEventListener('click', (e) => {
        e.preventDefault();
        const parentSection = button.closest('.section');
        parentSection.querySelectorAll('.sub-link.active').forEach(btn => btn.classList.remove('active'));
        parentSection.querySelectorAll('.sub-section.active').forEach(section => section.classList.remove('active'));
        button.classList.add('active');
        const targetId = button.dataset.subsection;
        parentSection.querySelector(`#${targetId}`).classList.add('active');
      });
    });

    // 3. CSRF 토큰 처리                                                               // CSRF 토큰 설정
    let csrftoken;
    const tokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
    if (tokenElement) {
      csrftoken = tokenElement.value;
    }

    // 4. 모바일 서브메뉴 토글                                                         // 모바일 메뉴 처리
    document.addEventListener('DOMContentLoaded', () => {
      const submenuParent = document.querySelector('.has-submenu');
      
      if (submenuParent && window.innerWidth <= 768) {
        submenuParent.addEventListener('click', (e) => {
          e.preventDefault();
          submenuParent.querySelector('.submenu').classList.toggle('active');
        });
      }
    });

    // 5. 이미지 에러 처리                                                             // 이미지 로드 실패 처리
    document.querySelectorAll('img').forEach(img => {
      img.addEventListener('error', (e) => {
        e.target.src = '{% static "community/images/no-image.png" %}';
        e.target.alt = 'Image not available';
      });
    });
  </script>
</body>
</html>


