<!-- community/templates/community/post.html -->

{% extends "community/base.html" %}
{% load static %}

{% block title %}글 작성{% endblock %}

{% block extrahead %}
  {{ form.media }}  <!-- This is critical for CKEditor widget to inject its scripts -->
{% endblock %}

{% block content %}
<section class="section active" id="post-section">
  <h2>글 작성</h2>
  
  

  <form method="POST" action="{% url 'community:post' %}" enctype="multipart/form-data">
    {% csrf_token %}
    
    <!-- 제목 필드 -->
    <div class="form-group">
        <label for="id_title">제목:</label>
        {{ form.title }}
    </div>

    <!-- 카테고리 필드 -->
    <div class="form-group">
        <label for="id_category">카테고리:</label>
        {{ form.category }}
    </div>

    <!-- 내용 필드 -->
    <div class="form-group">
      <label for="id_content">내용:</label>
      <!-- CKEditor field generated by the widget -->
      {{ form.content }}
  </div>
    
    <!-- 다중 이미지 업로드 필드 -->
    <div class="form-group">
        <label>이미지 업로드 (여러 파일 선택 가능):</label>
        <input type="file" name="post_images" multiple accept="image/*" onchange="previewImages(this)">
        <div id="imagePreview" style="margin-top: 10px;"></div>
    </div>
    
    <!-- 선택한 책 정보를 저장할 hidden input -->
    <input type="hidden" name="selected_book_data" id="selected_book_data">
    
    <button type="submit" class="btn hover-effect">글쓰기</button>
  </form>

  <!-- 검색 영역 -->
  <div>
    <input type="text" id="book-search-input" placeholder="책 검색어를 입력하세요" onkeypress="handleKeyPress(event)">
    <button type="button" onclick="searchBooks()" id="search-button">검색</button>
  </div>
  
  <!-- 검색 결과 표시 영역 -->
  <div id="search-results" style="margin-top:1em;">
    <!-- fetch()로 받은 책 리스트를 JavaScript로 여기다가 렌더링 -->
  </div>

</section>







<!----------------------------------------------------------------------------------------->

<!-- JavaScript 코드 -->



<script>
  // 엔터키 처리 함수 추가
  function handleKeyPress(event) {                      // 엔터키 입력 시 검색 실행
    if (event.key === 'Enter') {
      event.preventDefault();
      searchBooks();
    }
  }

  // 책 검색 함수 수정
  function searchBooks() {
    const query = document.getElementById('book-search-input').value.trim();
    if(!query){
        alert("검색어를 입력하세요!");
        return;
    }

    fetch(`/naver-book-json/?query=${encodeURIComponent(query)}`)
    .then(response => {
        if(!response.ok){
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        console.log('받은 데이터:', data);  // 디버깅을 위한 로그
        if (data && data.items) {
            displaySearchResults(data.items);
        } else {
            document.getElementById('search-results').innerHTML = '<p>검색 결과가 없습니다.</p>';
        }
    })
    .catch(error => {
        console.error('Error fetching data:', error);
        document.getElementById('search-results').innerHTML = '<p>검색 중 오류가 발생했습니다.</p>';
    });
  }

  // 2) 검색 결과를 화면에 표시
  function displaySearchResults(items) {
    const resultsDiv = document.getElementById('search-results');
    resultsDiv.innerHTML = ''; // 이전 검색 결과 초기화

    if(!items || items.length === 0) {
      resultsDiv.innerHTML = '<p>검색 결과가 없습니다.</p>';
      return;
    }

    // items 각각은 책 한 권 정보를 담고 있음
    items.forEach(book => {
      // 예: title, author, publisher, link, image 등
      const bookDiv = document.createElement('div');
      bookDiv.style.border = '1px solid #ccc';
      bookDiv.style.padding = '5px';
      bookDiv.style.margin = '5px 0';
      
      bookDiv.innerHTML = `
        <strong>${book.title}</strong><br>
        저자: ${book.author}<br>
        출판사: ${book.publisher}<br>
        <img src="${book.image}" style="max-width:100px;"><br>
        <button type="button" onclick='chooseBook(${JSON.stringify(book)})'>이 책 선택</button>
      `;
      resultsDiv.appendChild(bookDiv);
    });
  }

  // 3) 책 선택 시 숨겨진 input에 JSON으로 저장
  function chooseBook(book) {
    // book 객체를 문자열(JSON)로 변환
    const selectedBookData = JSON.stringify({
      title: book.title,
      author: book.author,
      publisher: book.publisher,
      pubdate: book.pubdate, 
      link: book.link,
      thumbnail_url: book.image // 네이버 API에서 이미지 필드가 "image" 일 수 있음
    });

    // hidden input에 설정
    document.getElementById('selected_book_data').value = selectedBookData;

    // 선택되었다는 표시를 UI로 확인할 수도 있음 (생략 가능)
    alert(`'${book.title}' 책이 선택되었습니다.`);
  }
</script>

{% endblock %}
