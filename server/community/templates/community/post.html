<!-- community/templates/community/post.html -->

{% extends 'community/index.html' %}
{% load static %}

{% block content %}
<section class="section active" id="post-section">
  <h2>글 작성</h2>
  
  

  <form method="POST" action="" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.as_p }}
    
    <!-- 사용자가 선택한 책 정보를 저장할 hidden input -->
    <input type="hidden" name="selected_book_data" id="selected_book_data" />
    
    <button type="submit" class="btn hover-effect">글쓰기</button>
  </form>

  <!-- 검색 영역 -->
  <div>
    <input type="text" id="book-search-input" placeholder="책 검색어를 입력하세요">
    <button type="button" onclick="searchBooks()">검색</button>
  </div>
  
  <!-- 검색 결과 표시 영역 -->
  <div id="search-results" style="margin-top:1em;">
    <!-- fetch()로 받은 책 리스트를 JavaScript로 여기다가 렌더링 -->
  </div>

</section>







<!----------------------------------------------------------------------------------------->

<!-- JavaScript 코드 -->



<script>
  // 1) 책 검색 함수 (Fetch API 사용)
  function searchBooks() {
    const query = document.getElementById('book-search-input').value.trim();
    if(!query){
      alert("검색어를 입력하세요!");
      return;
    }

    // 예: /naver-book-json/?query=검색어
    fetch(`/naver-book-json/?query=${encodeURIComponent(query)}`)
      .then(response => {
        if(!response.ok){
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        // naver_book_json 뷰에서 반환한 JSON 형식( { items: [...] } )에 맞게 처리
        // data가 어떤 형태인지 먼저 콘솔로 확인해볼 것
        console.log(data);
        displaySearchResults(data.items);
      })
      .catch(error => {
        console.error('Error fetching data:', error);
      });
  }

  // 2) 검색 결과를 화면에 표시
  function displaySearchResults(items) {
    const resultsDiv = document.getElementById('search-results');
    resultsDiv.innerHTML = ''; // 이전 검색 결과 초기화

    if(!items || items.length === 0) {
      resultsDiv.innerHTML = '<p>검색 결과가 없습니다.</p>';
      return;
    }

    // items 각각은 책 한 권 정보를 담고 있음
    items.forEach(book => {
      // 예: title, author, publisher, link, image 등
      const bookDiv = document.createElement('div');
      bookDiv.style.border = '1px solid #ccc';
      bookDiv.style.padding = '5px';
      bookDiv.style.margin = '5px 0';
      
      bookDiv.innerHTML = `
        <strong>${book.title}</strong><br>
        저자: ${book.author}<br>
        출판사: ${book.publisher}<br>
        <img src="${book.image}" style="max-width:100px;"><br>
        <button type="button" onclick='chooseBook(${JSON.stringify(book)})'>이 책 선택</button>
      `;
      resultsDiv.appendChild(bookDiv);
    });
  }

  // 3) 책 선택 시 숨겨진 input에 JSON으로 저장
  function chooseBook(book) {
    // book 객체를 문자열(JSON)로 변환
    const selectedBookData = JSON.stringify({
      title: book.title,
      author: book.author,
      publisher: book.publisher,
      pubdate: book.pubdate, 
      link: book.link,
      thumbnail_url: book.image // 네이버 API에서 이미지 필드가 "image" 일 수 있음
    });

    // hidden input에 설정
    document.getElementById('selected_book_data').value = selectedBookData;

    // 선택되었다는 표시를 UI로 확인할 수도 있음 (생략 가능)
    alert(`'${book.title}' 책이 선택되었습니다.`);
  }
</script>

{% endblock %}
