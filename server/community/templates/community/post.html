<!-- community/templates/community/post.html -->

{% extends "community/base.html" %}
{% load static %}

{% block title %}글 작성{% endblock %}

{% block content %}
<section class="section active" id="post-section">
  <h2>글 작성</h2>

  <form method="POST" action="{% url 'community:post' %}" enctype="multipart/form-data">
    {% csrf_token %}
    
    <!-- 제목 필드 -->
    <div class="form-group">
      <label for="{{ form.title.id_for_label }}">제목:</label>
      {{ form.title }}
      <small class="form-error">{{ form.title.errors }}</small>
    </div>

    <!-- 카테고리 필드 -->
    <div class="form-group">
      <label for="{{ form.category.id_for_label }}">카테고리:</label>
      {{ form.category }}
      <small class="form-error">{{ form.category.errors }}</small>
    </div>

    <!-- 태그 필드 -->
    <div class="form-group">
      <label for="{{ form.tags.id_for_label }}">태그:</label>
      {{ form.tags }}
      <small class="form-error">{{ form.tags.errors }}</small>
    </div>

    <!-- 내용 필드 -->
    <div class="form-group">
      <label for="{{ form.content.id_for_label }}">내용:</label>
      {{ form.content }}
      <small class="form-error">{{ form.content.errors }}</small>
    </div>
    
    <!-- 다중 이미지 업로드 필드 -->
    <div class="form-group">
        <label>이미지 업로드 (여러 파일 선택 가능):</label>
        <input type="file" name="post_images" multiple accept="image/*" onchange="previewImages(this)">
        <div id="imagePreview" style="margin-top: 10px;"></div>
    </div>
    
    <!-- 선택한 책 정보를 저장할 hidden input -->
    <input type="hidden" name="selected_book_data" id="selected_book_data">
    

    
    <button type="submit" class="btn hover-effect"> 글쓰기</button>
  </form>



  <!-- 검색 영역 -->
  <div>
    <input type="text" id="book-search-input" placeholder="책 검색어를 입력하세요" onkeypress="handleKeyPress(event)">
    <button type="button" onclick="searchBooks()" id="search-button">검색</button>
  </div>
  
  <!-- 검색 결과 표시 영역 -->
  <div id="search-results" style="margin-top:1em;">
    <!-- fetch()로 받은 책 리스트를 JavaScript로 여기다가 렌더링 -->
  </div>

</section>







<!----------------------------------------------------------------------------------------->

<!-- JavaScript 코드 -->



<script>
  // 엔터키 처리 함수
  function handleKeyPress(event) {
    if (event.key === 'Enter') {
      event.preventDefault();  // 엔터키 기본 동작 방지
      searchBooks();
    }
  }

  // 책 검색 함수 (Ajax) → 이 부분은 그대로 사용 가능
  function searchBooks() {
    const query = document.getElementById('book-search-input').value.trim();
    if(!query){
        alert("검색어를 입력하세요!");
        return;
    }

    // 검색 버튼 비활성화
    const searchButton = document.getElementById('search-button');
    searchButton.disabled = true;
    
    fetch(`/naver-book-json/?query=${encodeURIComponent(query)}`)
    .then(response => {
        if(!response.ok){
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data && data.items) {
            displaySearchResults(data.items);
        } else {
            document.getElementById('search-results').innerHTML = '<p>검색 결과가 없습니다.</p>';
        }
    })
    .catch(error => {
        console.error('Error fetching data:', error);
        document.getElementById('search-results').innerHTML = '<p>검색 중 오류가 발생했습니다.</p>';
    })
    .finally(() => {
        searchButton.disabled = false;  // 검색 완료 후 버튼 활성화
    });
  }

  function createBookElement(book) {
    const bookDiv = document.createElement('div');
    bookDiv.style.border = '1px solid #ccc';
    bookDiv.style.padding = '5px';
    bookDiv.style.margin = '5px 0';
    
    const title = document.createElement('strong');
    title.textContent = book.title;
    
    const authorText = document.createElement('div');
    authorText.textContent = '저자: ' + book.author;
    
    const publisherText = document.createElement('div');
    publisherText.textContent = '출판사: ' + book.publisher;
    
    const img = document.createElement('img');
    img.src = book.image;
    img.style.maxWidth = '100px';
    
    const button = document.createElement('button');
    button.type = 'button';
    button.textContent = '이 책 선택';
    button.onclick = () => chooseBook(book);
    
    bookDiv.appendChild(title);
    bookDiv.appendChild(document.createElement('br'));
    bookDiv.appendChild(authorText);
    bookDiv.appendChild(publisherText);
    bookDiv.appendChild(img);
    bookDiv.appendChild(document.createElement('br'));
    bookDiv.appendChild(button);
    
    return bookDiv;
  }

  function displaySearchResults(items) {
    const resultsDiv = document.getElementById('search-results');
    resultsDiv.innerHTML = '';

    if(!items || items.length === 0) {
        resultsDiv.innerHTML = '<p>검색 결과가 없습니다.</p>';
        return;
    }

    items.forEach(book => {
        resultsDiv.appendChild(createBookElement(book));
    });
  }

  function chooseBook(book) {
    const selectedBookData = JSON.stringify({
      title: book.title,
      author: book.author,
      publisher: book.publisher,
      pubdate: book.pubdate,
      link: book.link,
      thumbnail_url: book.image,
      isbn: book.isbn,
      description: book.description
    });

    document.getElementById('selected_book_data').value = selectedBookData;
    alert(`'${book.title}' 책이 선택되었습니다. (선택사항입니다)`);
  }

  // 이미지 미리보기 (선택 사항)
  function previewImages(input) {
    const previewDiv = document.getElementById('imagePreview');
    previewDiv.innerHTML = '';
    if (input.files) {
      for (let i = 0; i < input.files.length; i++) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.style.maxWidth = '150px';
          img.style.marginRight = '10px';
          previewDiv.appendChild(img);
        }
        reader.readAsDataURL(input.files[i]);
      }
    }
  }

  document.querySelector('form').addEventListener('submit', function(e) {
    // preventDefault 제거
    // 폼이 정상적으로 서버로 제출되도록 함
    const form = this;
    form.submit();  // 폼 제출
  });
</script>
{% endblock %}